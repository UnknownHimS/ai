<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>baby ai with Bible & Detective Q&A</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #0ff; padding: 20px; }
  input, button { padding: 10px; font-size: 16px; }
  button { margin-left: 10px; background: #0ff; border: none; color: #000; cursor: pointer; }
  #chat { max-width: 700px; height: 60vh; overflow-y: auto; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; border: 2px solid #0ff; }
  .user { color: #0f0; margin: 5px 0; white-space: pre-wrap; }
  .bot { color: #f0f; margin: 5px 0; white-space: pre-wrap; }
  a { color: #0ff; }
</style>
</head>
<body>

<h2>baby ai with Bible & Detective Q&A</h2>

<div id="chat"></div>

<div>
  <input type="text" id="userInput" placeholder="Ask about a person, Bible verse, detective clue, or type a name..." />
  <button onclick="sendMessage()">Send</button>
</div>

<script>
  const chat = document.getElementById('chat');
  const input = document.getElementById('userInput');

  // State for ambiguous wikipedia matches (for name clarifications)
  let ambiguousMatches = null;
  let lastQuery = "";

  // State for context tracking (Bible & Detective)
  let activeContext = null;

  // Loaded intents
  let bibleIntents = [];
  let detectiveIntents = [];
  let combinedIntents = [];

  // Replace with your actual raw URLs for the JSON files
  const BIBLE_JSON_URL = 'https://raw.githubusercontent.com/UnknownHimS/ai/main/bible.json';
  const DETECTIVE_JSON_URL = 'https://raw.githubusercontent.com/UnknownHimS/ai/main/detective.json';

  // Load Bible intents
  async function loadBibleIntents() {
    try {
      const res = await fetch(BIBLE_JSON_URL);
      bibleIntents = await res.json();
      appendMessage('bot', 'Bible Q&A intents loaded.');
    } catch (e) {
      appendMessage('bot', 'Failed to load Bible intents.');
      console.error(e);
    }
  }

  // Load Detective intents
  async function loadDetectiveIntents() {
    try {
      const res = await fetch(DETECTIVE_JSON_URL);
      detectiveIntents = await res.json();
      appendMessage('bot', 'Detective intents loaded.');
    } catch (e) {
      appendMessage('bot', 'Failed to load Detective intents.');
      console.error(e);
    }
  }

  // Load both intents and combine
  async function loadIntents() {
    await loadBibleIntents();
    await loadDetectiveIntents();
    combinedIntents = [...bibleIntents, ...detectiveIntents];
  }

  loadIntents();

  function appendMessage(sender, text) {
    const p = document.createElement('p');
    p.className = sender;
    p.textContent = (sender === 'user' ? 'ðŸ§‘ You: ' : 'ðŸ¤– ShabbyBot: ') + text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  // Extract date info from snippet parentheses (Wikipedia snippet)
  function extractDateFromSnippet(snippet) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = snippet;
    const cleanText = tempDiv.textContent || "";

    const parenRegex = /\(([^)]+)\)/g;
    let match;
    while ((match = parenRegex.exec(cleanText)) !== null) {
      const content = match[1].trim();
      // Ignore pure year ranges like 1990â€“1995
      if (/^\d{4}[â€“-]\d{4}$/.test(content)) continue;
      if (content.match(/\d{4}/)) return content;
    }
    return null;
  }

  // Fetch search results from Wikipedia API
  async function fetchWikiSearch(topic) {
    const endpoint = `https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=${encodeURIComponent(topic)}`;
    try {
      const res = await fetch(endpoint);
      if (!res.ok) return null;
      const data = await res.json();
      if (!data.query || !data.query.search || data.query.search.length === 0) return null;
      return data.query.search;
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  // Fetch snippet for a specific title
  async function fetchSnippetForTitle(title) {
    const endpoint = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&format=json&origin=*&titles=${encodeURIComponent(title)}`;
    try {
      const res = await fetch(endpoint);
      if (!res.ok) return null;
      const data = await res.json();
      const pages = data.query.pages;
      const page = Object.values(pages)[0];
      return page.extract || null;
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  // Match user input to any intent (Bible or Detective)
  function matchIntent(input) {
    const inputLower = input.toLowerCase();

    for (const intent of combinedIntents) {
      if (!intent.keywords) continue;
      const allKeywordsPresent = intent.keywords.every(k => inputLower.includes(k.toLowerCase()));
      if (allKeywordsPresent) {
        // Check required context if any
        if (intent.required_context && intent.required_context !== activeContext) {
          continue;
        }
        return intent;
      }
    }
    return null;
  }

  async function sendMessage() {
    const userText = input.value.trim();
    if (!userText) return;
    appendMessage('user', userText);
    input.value = '';

    // If waiting for ambiguous name clarification
    if (ambiguousMatches) {
      const matchedTitle = ambiguousMatches.find(title => title.toLowerCase() === userText.toLowerCase());
      if (matchedTitle) {
        appendMessage('bot', `Fetching info for ${matchedTitle}...`);
        const snippet = await fetchSnippetForTitle(matchedTitle);
        const dateInfo = extractDateFromSnippet(snippet || "");
        let reply = "";
        if (dateInfo) {
          reply = `${matchedTitle} dates found: ${dateInfo}`;
        } else {
          reply = `${matchedTitle} info: ${snippet || '(No date info found)'}`;
        }
        appendMessage('bot', reply);
        ambiguousMatches = null;
        lastQuery = matchedTitle;
        activeContext = null;
        return;
      } else {
        appendMessage('bot', `I couldn't find "${userText}" in the options. Please pick one of the following:\n${ambiguousMatches.join('\n')}`);
        return;
      }
    }

    // Try matching intent from Bible or Detective
    const intent = matchIntent(userText);
    if (intent) {
      if (intent.expecting) {
        activeContext = intent.id;
      } else {
        activeContext = null;
      }

      if (intent.output.startsWith("wiki:")) {
        const topic = intent.output.slice(5);
        appendMessage('bot', `Searching Wikipedia for "${topic}"...`);
        const results = await fetchWikiSearch(topic);
        if (!results) {
          appendMessage('bot', `No Wikipedia results found for "${topic}".`);
          return;
        }
        const single = results[0];
        const snippet = single.snippet;
        const title = single.title;
        const dateInfo = extractDateFromSnippet(snippet);

        if (dateInfo) {
          appendMessage('bot', `${title} dates found: ${dateInfo}`);
        } else {
          appendMessage('bot', `${title} info: ${snippet.replace(/<\/?[^>]+(>|$)/g, "")}... (No date info found)`);
        }
      } else {
        appendMessage('bot', intent.output);
      }
      return;
    }

    // No intent matched â†’ do Wikipedia search
    appendMessage('bot', 'Searching Wikipedia...');
    lastQuery = userText;
    activeContext = null;

    const results = await fetchWikiSearch(userText);
    if (!results) {
      appendMessage('bot', `No results found for "${userText}".`);
      return;
    }

    if (results.length > 1) {
      const titles = results.slice(0, 5).map(r => r.title);
      ambiguousMatches = titles;

      appendMessage('bot', `I found multiple matches for "${userText}":\n${titles.map((t, i) => `${i+1}. ${t}`).join('\n')}\nPlease type the exact name to clarify.`);
      return;
    }

    // Single result
    const single = results[0];
    const snippet = single.snippet;
    const title = single.title;
    const dateInfo = extractDateFromSnippet(snippet);

    if (dateInfo) {
      appendMessage('bot', `${title} dates found: ${dateInfo}`);
    } else {
      appendMessage('bot', `${title} info: ${snippet.replace(/<\/?[^>]+(>|$)/g, "")}... (No date info found)`);
    }
  }

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage();
  });
</script>

</body>
</html>
