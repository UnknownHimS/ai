<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wiki Search with Speech</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 30px auto;
    background: #f0f4f8;
    padding: 20px;
  }
  h2 {
    border-bottom: 2px solid #4a90e2;
    padding-bottom: 5px;
    margin-top: 40px;
  }
  .container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px #aaa4;
    margin-top: 20px;
  }
  button {
    font-size: 1.1rem;
    padding: 10px 18px;
    margin: 10px 8px 10px 0;
    cursor: pointer;
  }
  #wiki-transcript {
    background: #eef5fb;
    padding: 15px;
    min-height: 120px;
    white-space: pre-wrap;
    border-radius: 6px;
    border: 1px solid #c1d3f8;
    margin-top: 10px;
  }
  #wiki-status {
    font-weight: bold;
    margin-top: 10px;
    min-height: 1.4em;
    color: #333;
  }
</style>
</head>
<body>

<section class="container" id="wiki-container">
  <h2>Wiki Search (Say "stop" to search)</h2>
  <button id="wiki-start-btn">Start Listening</button>
  <button id="wiki-stop-btn" disabled>Stop Listening</button>
  <div id="wiki-status">Press "Start Listening", say your topic, then say "stop" to search Wikipedia.</div>
  <div id="wiki-transcript"></div>
</section>

<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const wikiStartBtn = document.getElementById("wiki-start-btn");
  const wikiStopBtn = document.getElementById("wiki-stop-btn");
  const wikiStatusDiv = document.getElementById("wiki-status");
  const wikiTranscriptDiv = document.getElementById("wiki-transcript");

  let wikiRecognition;
  let wikiListening = false;

  let voices = [];
  function loadVoices() {
    voices = speechSynthesis.getVoices();
    if (!voices.length) setTimeout(loadVoices, 100);
  }
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function speak(text) {
    return new Promise((resolve, reject) => {
      if (!text) return resolve();
      if (speechSynthesis.speaking) speechSynthesis.cancel();

      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 0.85;
      utter.pitch = 1.1;

      const voice = voices.find(v => v.lang.startsWith("en") && v.name.toLowerCase().includes("male")) || voices.find(v => v.lang.startsWith("en"));
      if (voice) utter.voice = voice;

      utter.onend = () => resolve();
      utter.onerror = (e) => reject(e);

      speechSynthesis.speak(utter);
    });
  }

  function fetchWikiSummary(query) {
    return fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`)
      .then(res => {
        if (!res.ok) throw new Error("No Wikipedia page found");
        return res.json();
      })
      .then(data => data.extract || "")
      .catch(() => "");
  }

  if (!SpeechRecognition) {
    wikiStartBtn.disabled = true;
    wikiStopBtn.disabled = true;
    wikiStatusDiv.textContent = "Speech Recognition API not supported in this browser.";
    wikiTranscriptDiv.textContent = "";
  } else {
    wikiStartBtn.addEventListener("click", () => {
      if (wikiListening) return;

      wikiRecognition = new SpeechRecognition();
      wikiRecognition.lang = "en-US";
      wikiRecognition.continuous = true;
      wikiRecognition.interimResults = true;

      let finalTranscript = "";

      wikiRecognition.onresult = (event) => {
        let interimTranscript = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          let transcriptPart = event.results[i][0].transcript.toLowerCase();

          if (transcriptPart.includes("stop")) {
            transcriptPart = transcriptPart.replace(/\bstop\b/g, "").trim();

            if (event.results[i].isFinal) finalTranscript += transcriptPart + " ";
            else interimTranscript += transcriptPart + " ";

            wikiRecognition.stop();
            return;
          } else {
            if (event.results[i].isFinal) finalTranscript += transcriptPart + " ";
            else interimTranscript += transcriptPart + " ";
          }
        }

        wikiTranscriptDiv.textContent = finalTranscript + interimTranscript;
        wikiStatusDiv.textContent = "üé§ Listening... Say 'stop' to search";
      };

      wikiRecognition.onerror = (event) => {
        wikiStatusDiv.textContent = `‚ùå Recognition error: ${event.error}`;
        stopWikiRecognition();
      };

      wikiRecognition.onend = async () => {
        if (!wikiListening) return;

        wikiListening = false;
        wikiStartBtn.disabled = false;
        wikiStopBtn.disabled = true;

        let query = wikiTranscriptDiv.textContent.trim();
        if (!query) {
          wikiStatusDiv.textContent = "‚ö†Ô∏è No query detected. Press 'Start Listening' to try again.";
          return;
        }

        wikiStatusDiv.textContent = `‚è≥ Searching Wikipedia for: "${query}"...`;
        try {
          const summary = await fetchWikiSummary(query);
          if (summary) {
            wikiTranscriptDiv.textContent = summary;
            wikiStatusDiv.textContent = "üì¢ Speaking Wikipedia summary...";
            await speak(summary);
            wikiStatusDiv.textContent = "‚úÖ Done! Press 'Start Listening' to ask again.";
          } else {
            wikiStatusDiv.textContent = `‚ö†Ô∏è No Wikipedia summary found for "${query}".`;
            await speak(`Sorry, I couldn't find anything about ${query}.`);
          }
        } catch {
          wikiStatusDiv.textContent = "‚ùå Error fetching Wikipedia data.";
          await speak("Sorry, there was an error fetching the data.");
        }
      };

      wikiRecognition.start();
      wikiListening = true;
      wikiStartBtn.disabled = true;
      wikiStopBtn.disabled = false;
      wikiStatusDiv.textContent = "üéß Listening... Say your topic, then say 'stop' to search Wikipedia.";
      wikiTranscriptDiv.textContent = "";
    });

    wikiStopBtn.addEventListener("click", stopWikiRecognition);

    function stopWikiRecognition() {
      if (!wikiListening) return;
      wikiRecognition.stop();
      wikiListening = false;
      wikiStartBtn.disabled = false;
      wikiStopBtn.disabled = true;
      wikiStatusDiv.textContent = "üõë Listening stopped. Press 'Start Listening' to try again.";
    }
  }
</script>

</body>
</html>
