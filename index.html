<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bible AI Chatbot</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    color: #333;
    max-width: 700px;
    margin: 2rem auto;
    padding: 1rem;
  }
  h1 {
    text-align: center;
  }
  #chat {
    border: 1px solid #ccc;
    height: 400px;
    overflow-y: auto;
    padding: 1rem;
    background: #fff;
    margin-bottom: 1rem;
  }
  #chat p {
    margin: 0.5rem 0;
  }
  .user {
    color: blue;
  }
  .bot {
    color: green;
  }
  #inputArea {
    display: flex;
    gap: 0.5rem;
  }
  #userInput {
    flex: 1;
    padding: 0.5rem;
    font-size: 1rem;
  }
  #sendBtn {
    padding: 0.5rem 1rem;
    font-size: 1rem;
  }
  label {
    display: block;
    margin-top: 1rem;
  }
  select {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
  }
</style>
</head>
<body>

<h1>Bible AI Chatbot</h1>

<label for="translationSelect">Choose Translation:</label>
<select id="translationSelect"></select>

<label for="bookSelect">Choose Book:</label>
<select id="bookSelect"></select>

<label for="chapterSelect">Choose Chapter:</label>
<select id="chapterSelect"></select>

<div id="chat"></div>

<div id="inputArea">
  <input type="text" id="userInput" placeholder="Ask about Bible verses, people, or topics..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<script>
(async function() {
  const apiBase = 'https://bible.helloao.org/api';

  const translationSelect = document.getElementById('translationSelect');
  const bookSelect = document.getElementById('bookSelect');
  const chapterSelect = document.getElementById('chapterSelect');
  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  let booksData = [];
  let currentTranslation = null;

  // Append message to chat
  function appendMessage(sender, text) {
    const p = document.createElement('p');
    p.className = sender;
    p.textContent = (sender === 'user' ? 'You: ' : 'BibleAI: ') + text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  // Load translations
  async function loadTranslations() {
    try {
      const res = await fetch(`${apiBase}/available_translations.json`);
      const data = await res.json();
      for (const [code, info] of Object.entries(data)) {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = `${info.name} (${code.toUpperCase()})`;
        translationSelect.appendChild(opt);
      }
      currentTranslation = translationSelect.value = 'kjv'; // default to KJV if exists
      loadBooks(currentTranslation);
    } catch(e) {
      appendMessage('bot', 'Failed to load translations.');
    }
  }

  // Load books for selected translation
  async function loadBooks(translation) {
    bookSelect.innerHTML = '';
    chapterSelect.innerHTML = '';
    try {
      const res = await fetch(`${apiBase}/${translation}/books.json`);
      booksData = await res.json();
      booksData.forEach(book => {
        const opt = document.createElement('option');
        opt.value = book.short_name;
        opt.textContent = book.name;
        bookSelect.appendChild(opt);
      });
      loadChapters(translation, booksData[0].short_name);
    } catch(e) {
      appendMessage('bot', 'Failed to load books.');
    }
  }

  // Load chapters for book
  function loadChapters(translation, bookShortName) {
    chapterSelect.innerHTML = '';
    const book = booksData.find(b => b.short_name === bookShortName);
    if (!book) return;
    for (let i = 1; i <= book.chapters; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      chapterSelect.appendChild(opt);
    }
  }

  // Load verses from API for a chapter
  async function loadVerses(translation, book, chapter) {
    try {
      const res = await fetch(`${apiBase}/${translation}/${book}/${chapter}.json`);
      if (!res.ok) throw new Error('Chapter not found');
      const data = await res.json();
      return data.verses; // array of verses {verse, text}
    } catch (e) {
      return null;
    }
  }

  // Simple NLP: Extract main keyword/topic (remove stopwords and common question words)
  function extractKeywords(text) {
    const stopwords = ['who','what','when','where','why','how','is','are','was','were','the','a','an','of','on','in','to','by','for','about','do','does','did','tell','me','please','give','show','say','verse','verses'];
    return text
      .toLowerCase()
      .replace(/[^\w\s]/g, '')
      .split(' ')
      .filter(word => word && !stopwords.includes(word))
      .slice(0, 3)
      .join(' ');
  }

  // Detect if input is asking for verse, info about a person, or other intent
  function detectIntent(text) {
    const lower = text.toLowerCase();
    if (/verse|chapter|book/.test(lower)) return 'verse';
    if (/who|when|where|why|how/.test(lower)) return 'info';
    return 'verse'; // default to verse search
  }

  // Search all books and chapters for verses containing the keyword (limiting chapters searched for demo)
  async function searchVerses(keyword) {
    appendMessage('bot', `Searching for verses containing "${keyword}"... This may take a few seconds.`);
    const versesFound = [];

    // For performance, limit to first 5 books and first 3 chapters each (demo only)
    const booksToSearch = booksData.slice(0, 5);

    for (const book of booksToSearch) {
      const chaptersToSearch = Math.min(book.chapters, 3);
      for (let ch = 1; ch <= chaptersToSearch; ch++) {
        const verses = await loadVerses(currentTranslation, book.short_name, ch);
        if (!verses) continue;
        for (const verse of verses) {
          if (verse.text.toLowerCase().includes(keyword.toLowerCase())) {
            versesFound.push(`${book.name} ${ch}:${verse.verse} - ${verse.text}`);
            if (versesFound.length >= 5) break; // limit number of results
          }
        }
        if (versesFound.length >= 5) break;
      }
      if (versesFound.length >= 5) break;
    }

    return versesFound.length > 0 ? versesFound.join('\n\n') : `No verses found with "${keyword}".`;
  }

  // Main respond function
  async function getResponse(inputText) {
    appendMessage('user', inputText);
    const intent = detectIntent(inputText);
    const keyword = extractKeywords(inputText);

    if (!keyword) return 'Please specify a topic or word to search for.';

    if (intent === 'verse') {
      // Search verses for the keyword
      const result = await searchVerses(keyword);
      return result;
    } else if (intent === 'info') {
      // For now, just do a simple fallback: search verses and prepend 'Info about keyword'
      const verses = await searchVerses(keyword);
      return `Info about "${keyword}":\n\n${verses}`;
    } else {
      return "I didn't understand your request. Please ask about Bible verses or info.";
    }
  }

  // Event handlers
  translationSelect.addEventListener('change', e => {
    currentTranslation = e.target.value;
    loadBooks(currentTranslation);
  });

  bookSelect.addEventListener('change', e => {
    loadChapters(currentTranslation, e.target.value);
  });

  sendBtn.addEventListener('click', async () => {
    const text = userInput.value.trim();
    if (!text) return;
    sendBtn.disabled = true;
    const response = await getResponse(text);
    appendMessage('bot', response);
    userInput.value = '';
    sendBtn.disabled = false;
  });

  userInput.addEventListener('keydown', async e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // Initial load
  await loadTranslations();

})();
</script>

</body>
</html>
