<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sci-Fi AI Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
  <style>
    body {
      background: radial-gradient(circle at center, #000 30%, #111 100%);
      color: #0ff;
      font-family: 'Orbitron', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
      overflow: hidden;
    }
    #chat {
      width: 90%;
      max-width: 700px;
      height: 70vh;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #0ff;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      box-shadow: 0 0 20px #0ff;
      border-radius: 10px;
    }
    #chat p {
      margin: 5px 0;
    }
    .user {
      color: #0f0;
    }
    .bot {
      color: #f0f;
    }
    #inputArea {
      width: 90%;
      max-width: 700px;
      display: flex;
    }
    #inputArea input {
      flex: 1;
      padding: 10px;
      border: none;
      background: #222;
      color: #0ff;
      font-family: 'Orbitron', sans-serif;
    }
    #inputArea button {
      background: #0ff;
      color: #000;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
    }
    #inputArea button:hover {
      background: #0cc;
    }
    a {
      margin-top: 10px;
      color: #0ff;
      text-decoration: none;
      font-family: 'Orbitron', sans-serif;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Please use proper spelling; this chatbot is still learning.</h1>

  <div id="chat"></div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="Type a message..." autocomplete="off" />
    <button id="sendBtn">Send</button>
  </div>
  <a href="main.html">DataWeb</a>

<script>
  (function() {
    const chat = document.getElementById('chat');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    const dataFiles = {
      bible: "https://raw.githubusercontent.com/UnknownHimS/ai/main/bible.json"
    };

    let loadedData = {};
    let currentContext = null;

    function appendMessage(sender, text) {
      const p = document.createElement('p');
      p.className = sender;
      p.textContent = (sender === 'user' ? 'ðŸ§‘ You: ' : 'ðŸ¤– ShabbyBot: ') + text;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }

    async function loadData(category) {
      if (!loadedData[category]) {
        try {
          const response = await fetch(dataFiles[category]);
          if (response.ok) {
            const json = await response.json();
            loadedData[category] = json;
          } else {
            loadedData[category] = [];
          }
        } catch (e) {
          console.error('Failed to load data:', e);
          loadedData[category] = [];
        }
      }
      return loadedData[category];
    }

    function matchKeywords(keywords, text) {
      const lowerText = text.toLowerCase();
      // Check if ANY keyword is included (change from 'every' to 'some' for better matching)
      return keywords.some(kw => lowerText.includes(kw.toLowerCase()));
    }

    function detectIntent(input) {
      const lower = input.toLowerCase();
      if (lower.includes("born")) return "born";
      if (lower.includes("died")) return "died";
      if (lower.includes("when")) return "when";
      if (lower.includes("who")) return "who";
      if (lower.includes("where")) return "where";
      if (lower.includes("how")) return "how";
      if (lower.includes("why")) return "why";
      if (lower.includes("what")) return "what";
      return "what";
    }

    function extractSmartTopic(input) {
      const lower = input.toLowerCase().replace(/[?.,!]/g, '');
      const stopwords = ['what', 'who', 'when', 'where', 'how', 'why', 'born', 'died', 'is', 'are', 'was', 'were', 'the', 'a', 'an', 'of', 'on', 'in', 'to', 'by', 'for', 'about', 'do', 'does', 'did', 'explain', 'define', 'tell', 'me', 'it', 'that', 'you'];
      const words = lower.split(' ').filter(word => !stopwords.includes(word));
      return words.slice(0, 4).join(' ');
    }

    async function fetchWikiWithIntent(input) {
      const intent = detectIntent(input);
      const topic = extractSmartTopic(input);

      if (!topic) return "I couldn't figure out what to search for.";

      const encodedTopic = encodeURIComponent(topic);
      const url = `https://en.wikipedia.org/w/rest.php/v1/page/${encodedTopic}`;

      try {
        const res = await fetch(url);
        if (!res.ok) return `I couldn't find anything about "${topic}".`;

        const data = await res.json();
        const htmlSummary = data.lead?.sections?.[0]?.text || data.lead?.sections?.[0]?.content || "";

        const summary = htmlSummary.replace(/<[^>]*>?/gm, '') || "No summary available.";

        switch (intent) {
          case 'when': {
            const match = summary.match(/\b(1[0-9]{3}|2[0-9]{3})\b/);
            return match ? `It happened in ${match[0]}.` : summary;
          }
          case 'who': {
            const whoMatch = summary.match(/^([A-Z][a-z]+(?:\s[A-Z][a-z]+)+)/);
            return whoMatch ? `It was ${whoMatch[1]}.` : summary;
          }
          case 'where': {
            const whereMatch = summary.match(/in\s([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/);
            return whereMatch ? `It happened in ${whereMatch[1]}.` : summary;
          }
          case 'why': {
            const whyMatch = summary.match(/because\s(.+?)\./i);
            return whyMatch ? `Because ${whyMatch[1]}.` : summary;
          }
          case 'how': {
            const howMatch = summary.match(/by\s(.+?)\./i);
            return howMatch ? `It happens by ${howMatch[1]}.` : summary;
          }
          case 'born':
          case 'died': {
            const bornDiedMatch = summary.match(/(\d{4})/);
            return bornDiedMatch ? `${intent.charAt(0).toUpperCase() + intent.slice(1)} in ${bornDiedMatch[0]}.` : summary;
          }
          default:
            return summary;
        }
      } catch (err) {
        console.error(err);
        return "There was a problem fetching info from Wikipedia.";
      }
    }

    async function getResponse(text) {
      text = text.toLowerCase();

      if (currentContext) {
        for (const category in loadedData) {
          const data = loadedData[category];
          for (const entry of data) {
            if (entry.required_context === currentContext && entry.keywords) {
              if (entry.keywords.includes(text)) {
                currentContext = null;
                return entry.output;
              }
            }
          }
        }
        return "I was waiting for a 'yes' or 'no' answer.";
      }

      const categoriesToLoad = Object.keys(dataFiles);
      await Promise.all(categoriesToLoad.map(cat => loadData(cat)));

      for (const category of categoriesToLoad) {
        const data = loadedData[category];
        for (const entry of data) {
          if (entry.__comment) continue;
          if (entry.keywords && matchKeywords(entry.keywords, text)) {
            if (entry.expecting) currentContext = entry.id;
            if (entry.output.startsWith("wiki:")) {
              const topic = entry.output.replace("wiki:", "").trim();
              return await fetchWikiWithIntent(topic);
            }
            return entry.output;
          }
        }
      }

      return await fetchWikiWithIntent(text);
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      appendMessage('user', text);
      input.value = '';
      sendBtn.disabled = true;  // disable to prevent multiple clicks

      try {
        const botReply = await getResponse(text);
        appendMessage('bot', botReply);
      } catch (err) {
        appendMessage('bot', "Oops, something went wrong.");
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }

    sendBtn.addEventListener('click', sendMessage);

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault(); // prevent form submit or default
        sendMessage();
      }
    });
  })();
</script>

</body>
</html>
