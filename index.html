<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wiki Multi‚ÄëTopic Search + TTS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 30px auto;
      background: #fafafa;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px #ccc;
    }
    button {
      padding: 8px 14px;
      font-size: 1rem;
      margin-left: 10px;
      cursor: pointer;
    }
    .topic-block {
      margin: 15px 0;
      padding: 10px;
      background: #eef5ff;
      border: 1px solid #c0d4ff;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .topic-title {
      font-weight: bold;
      font-size: 1.1rem;
    }
    #status {
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    #results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Wiki Search + Multiple Topics</h2>
    <button id="listen-btn">Start Listening</button>
    <button id="stop-btn" disabled>Stop Listening</button>
    <div id="status">Click ‚ÄúStart Listening‚Äù, say topics (like "Batman and Einstein"), then say ‚Äústop‚Äù.</div>
    <div id="results"></div>
  </div>

  <script>
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const listenBtn = document.getElementById('listen-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');

    let recognition;
    let listening = false;
    let currentUtterance = null;

    // load voices for TTS
    let voices = [];
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      if (!voices.length) setTimeout(loadVoices, 100);
    }
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    function speak(text) {
      if (!text) return;
      if (speechSynthesis.speaking && currentUtterance) {
        speechSynthesis.cancel();
      }
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.rate = 0.9;
      currentUtterance.pitch = 1.0;
      const voice = voices.find(v => v.lang.startsWith('en')) || null;
      if (voice) currentUtterance.voice = voice;
      speechSynthesis.speak(currentUtterance);
    }

    function extractTopics(raw) {
      raw = raw.toLowerCase();
      const filler = ['what','is','the','a','an','and','tell','me','about','please','of','for'];
      let words = raw.split(/\s+/).filter(w => w && !filler.includes(w));
      const parts = raw.split(/\band\b/);
      if (parts.length > 1) {
        return parts.map(p => p.trim()).filter(p => p.length > 0);
      }
      const parts2 = raw.split(/,|;/);
      if (parts2.length > 1) {
        return parts2.map(p => p.trim()).filter(p => p.length > 0);
      }
      return [ raw.trim() ];
    }

    async function searchTopics(query) {
      const url = `https://en.wikipedia.org/w/api.php?action=query&origin=*&format=json&list=search&srsearch=${encodeURIComponent(query)}&srlimit=5`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.query && data.query.search) {
          return data.query.search.map(item => item.title);
        }
        return [];
      } catch (err) {
        console.error('searchTopics error', err);
        return [];
      }
    }

    async function fetchSummary(title) {
      const url = `https://en.wikipedia.org/w/api.php?action=query&origin=*&format=json&prop=extracts&exintro=true&explaintext=true&redirects=1&titles=${encodeURIComponent(title)}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const pages = data.query.pages;
        const pid = Object.keys(pages)[0];
        if (pid === "-1") return `No summary found for "${title}".`;
        return pages[pid].extract || `No extract available for "${title}".`;
      } catch (err) {
        console.error('fetchSummary error', err);
        return `Failed to fetch summary for "${title}".`;
      }
    }

    listenBtn.addEventListener('click', () => {
      if (!SpeechRecognition) {
        statusDiv.textContent = "SpeechRecognition not supported in this browser.";
        return;
      }
      if (listening) return;

      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.continuous = true;
      recognition.interimResults = true;

      let finalTranscript = "";

      recognition.onresult = (evt) => {
        let interim = "";
        for (let i = evt.resultIndex; i < evt.results.length; i++) {
          let part = evt.results[i][0].transcript;
          if (part.toLowerCase().includes("stop")) {
            part = part.replace(/stop/gi, "").trim();
            if (evt.results[i].isFinal) finalTranscript += part + " ";
            recognition.stop();
            break;
          } else {
            if (evt.results[i].isFinal) finalTranscript += part + " ";
            else interim += part + " ";
          }
        }
        statusDiv.textContent = "üéß You said: " + (finalTranscript + interim).trim();
      };

      recognition.onend = async () => {
        listening = false;
        stopBtn.disabled = true;

        const raw = statusDiv.textContent.replace("üéß You said:","").trim();
        if (!raw) {
          statusDiv.textContent = "No speech detected. Try again.";
          return;
        }

        statusDiv.textContent = `Searching topics for "${raw}"...`;
        const topics = extractTopics(raw);
        let allTitles = [];
        for (const t of topics) {
          const titles = await searchTopics(t);
          allTitles = allTitles.concat(titles);
        }
        allTitles = [...new Set(allTitles)];
        if (allTitles.length === 0) {
          statusDiv.textContent = `No topics found for "${raw}".`;
          return;
        }
        statusDiv.textContent = `Found these topics:`;
        resultsDiv.innerHTML = '';
        for (const title of allTitles) {
          const block = document.createElement('div');
          block.className = 'topic-block';

          const titleElem = document.createElement('span');
          titleElem.className = 'topic-title';
          titleElem.textContent = title;

          const btnSpeak = document.createElement('button');
          btnSpeak.textContent = 'üîä Speak summary';
          btnSpeak.addEventListener('click', async () => {
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            statusDiv.textContent = `Fetching summary for "${title}"...`;
            const summary = await fetchSummary(title);
            statusDiv.textContent = `Speaking summary for "${title}"...`;
            speak(summary);
            // reset status after speech ends
            currentUtterance.onend = () => {
              statusDiv.textContent = 'Click ‚ÄúStart Listening‚Äù, say topics, then say ‚Äústop‚Äù.';
            };
          });

          block.appendChild(titleElem);
          block.appendChild(btnSpeak);
          resultsDiv.appendChild(block);
        }
      };

      recognition.onerror = (e) => {
        statusDiv.textContent = `Error: ${e.error}`;
        listening = false;
      };

      recognition.start();
      listening = true;
      statusDiv.textContent = "üé§ Listening... speak now then say 'stop'";
      stopBtn.disabled = false;
      resultsDiv.innerHTML = '';
    });

    stopBtn.addEventListener('click', () => {
      if (listening && recognition) recognition.stop();
    });
  </script>
</body>
</html>
